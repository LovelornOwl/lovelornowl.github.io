---
layout: post
title: Arduino六度空气PM2.5激光传感器
modified: 2016-07-15
tags: [Arduino]

---
![pm25](../images/pm25.jpg)
首先dht11的data接arduino的D2,1602转接板的sda以及scl分别接a4和a5,六度传感器的5接arduino的rx
然后记得要将Wire和 LiquidCrystal_I2C以及dht11的库函数放到Arduino的library目录下
前两个库是1602转接板的,最后一个是温湿度传感器的
接着把下面的代码拷进Arduino就行了 ![happy](../images/aru/77.png)

```c
#include <Wire.h> 
#include <LiquidCrystal_I2C.h>
#include <dht11.h>
#define DHT11PIN 2
#define DataSize 4
#define MaxQueueSize 60
#define DelayTime 1000

dht11 DHT11;
LiquidCrystal_I2C lcd(0x27,16,2);

int receivedData[7] = {0};
int receivedCount = 0;
int receivedLength = 0;
int didEndReceive = 0;

double pm25Queue [MaxQueueSize] = {0.0};
double pm10Queue [MaxQueueSize] = {0.0};
int queueIndex = 0;

void enqueue(double pm25,double pm10){
  if (queueIndex<MaxQueueSize){
    pm25Queue[queueIndex] = pm25;
    pm10Queue[queueIndex] = pm10;
    queueIndex++;
  }
  else{
    for(int i=0; i<queueIndex-1; i++){
      pm25Queue[i] = pm25Queue[i+1];
      pm10Queue[i] = pm10Queue[i+1];
    }

    pm25Queue[queueIndex - 1] = pm25;
    pm10Queue[queueIndex - 1] = pm10;
  }
}
double getPM25(){
  double sum = 0;
  for(int i=0; i<MaxQueueSize; i++){
    sum += pm25Queue[i];
  }
  return sum / (queueIndex+1);
}
double getPM10(){
  double sum = 0;
  for(int i=0; i<MaxQueueSize; i++){
    sum += pm10Queue[i];
  }
  return sum / (queueIndex+1);
}
void printToLcd(){

  lcd.setCursor(0,0);
  lcd.print((double)DHT11.temperature,2);
  lcd.print("      ");
  lcd.print((double)DHT11.humidity,2);
  
  lcd.setCursor(0,1);
  lcd.print(getPM25(),2);
  lcd.print("      ");
  lcd.print(getPM10(),2);

}

void clear(void)
{
    receivedLength = 0;
    receivedCount = 0;
    didEndReceive = 0;
}

void receiveData(int data)
{
  if(data == 170)
  {
    didEndReceive = 0;
    receivedLength = 0;
    receivedCount = 0;
  }
  if(data == 255)
  {
    didEndReceive = 1;
    receivedLength = 7;
  }
  receivedData[receivedCount++] = data;
}

void commonRecive(void)
{

  if((didEndReceive == 1)&&(receivedLength > 6))
  {
    if((receivedData[0] == 170)&&(receivedData[6] == 255))
    {
      if(receivedData[5] == (receivedData[1] + receivedData[2] + receivedData[3] + receivedData[4]) % 256)
      {
        double pm25 = (receivedData[1]*256+receivedData[2])*0.1;
        double pm10 = (receivedData[3]*256+receivedData[4])*0.1;

        enqueue(pm25,pm10);
        
        Serial.println("Original:");
        Serial.println(pm25);
        Serial.println(pm10);

        Serial.println("Averaged:");
        Serial.println(getPM25());
        Serial.println(getPM10());

        printToLcd();

        clear();
      }
    }
    else
    {
      clear();
    }
  }
}

void setup(){

  Serial.begin(9600);
  lcd.init();
  lcd.backlight();

}
 
void loop(){

  while (Serial.available()>0){

    receiveData(Serial.read());
     
  }

  commonRecive();
  delay(DelayTime);
}
```



最后要注意的是,在写入数据的时候以及开机的时候记得要断开传感器与Arduino的连接,因为USB也是用的串口通信,不断开会写不进去数据,写进去过后如果开机不断开数据会出错 ![smoke](../images/aru/45.png)